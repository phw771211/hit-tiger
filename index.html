<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è±¡æ£‹åƒå¢© PVP v30.50 - å…¨æ–°è¦å‰‡ç‰ˆ</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --gold: #f1c40f; --red: #e74c3c; --table: #2e7d32; --card-back: #2c3e50; }
        body { background: #1a1a1a; color: white; font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; overflow: hidden; }
        
        .table { width: 700px; height: 700px; background: var(--table); border: 12px solid #5d4037; border-radius: 50%; position: relative; box-shadow: inset 0 0 100px #000; display: none; }
        
        .player { position: absolute; text-align: center; width: 360px; z-index: 10; padding: 10px; border-radius: 15px; }
        .p-0 { bottom: 10px; left: 50%; transform: translateX(-50%); }
        .p-1 { left: -140px; top: 50%; transform: translateY(-50%) rotate(90deg); }
        .p-2 { top: 10px; left: 50%; transform: translateX(-50%) rotate(180deg); }
        .p-3 { right: -140px; top: 50%; transform: translateY(-50%) rotate(-90deg); }
        
        .active-glow { background: rgba(241, 196, 15, 0.3); box-shadow: 0 0 25px var(--gold); }
        .hand { display: flex; gap: 5px; justify-content: center; min-height: 80px; margin-top: 5px; flex-wrap: nowrap; width: 100%; }
        
        .card { width: 40px; height: 60px; background: white; color: black; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px; border: 2px solid #333; cursor: pointer; transition: transform 0.2s; flex-shrink: 0; }
        .card.red-p { color: var(--red); border-color: var(--red); }
        .card.selected { transform: translateY(-18px); border: 3px solid var(--gold); box-shadow: 0 5px 15px var(--gold); }
        .card.confirmed { opacity: 0.4; filter: grayscale(0.8); transform: translateY(-12px); cursor: default; }
        .card.back { background: var(--card-back) !important; color: transparent !important; border-color: #fff; }
        
        .slot { position: absolute; width: 150px; height: 110px; display: flex; justify-content: center; align-items: center; gap: 4px; background: rgba(0,0,0,0.15); border: 2px dashed rgba(255,255,255,0.2); border-radius: 10px; pointer-events: none; }
        .slot-0 { bottom: 200px; left: 50%; transform: translateX(-50%); }
        .slot-1 { left: 160px; top: 50%; transform: translateY(-50%) rotate(90deg); }
        .slot-2 { top: 200px; left: 50%; transform: translateX(-50%) rotate(180deg); }
        .slot-3 { right: 160px; top: 50%; transform: translateY(-50%) rotate(-90deg); }
        
        .slot .revealed-card { width: 40px; height: 60px; background: white; color: black; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px; border: 2px solid #333; }
        .slot .revealed-card.red-p { color: var(--red); border-color: var(--red); }
        .slot .hidden-win { background: #555 !important; border-color: #333 !important; color: transparent !important; }
        
        .tricks { display: flex; gap: 2px; height: 25px; justify-content: center; margin-bottom: 5px; flex-wrap: wrap; max-width: 250px; margin: 0 auto; }
        .trick-tag { width: 22px; height: 22px; background: #fff; color: #000; font-size: 13px; font-weight: bold; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid #333; }
        .trick-tag.red-p { color: var(--red); border-color: var(--red); }

        /* è¦å‰‡æŒ‰éˆ•èˆ‡å½ˆçª— */
        #rule-btn { position: fixed; top: 20px; left: 20px; padding: 10px 20px; background: rgba(0,0,0,0.5); border: 1px solid var(--gold); color: var(--gold); border-radius: 20px; cursor: pointer; z-index: 1000; }
        #rule-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 20000; padding: 20px; }
        .rule-content { background: #2c3e50; border: 2px solid var(--gold); padding: 25px; border-radius: 15px; max-width: 450px; line-height: 1.5; font-size: 14px; }

        #settlement-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 10000; }
        button { padding: 15px 35px; background: #e67e22; color: white; border: none; border-radius: 30px; cursor: pointer; font-weight: bold; font-size: 18px; }
        button:disabled { background: #7f8c8d; cursor: not-allowed; }
        input#nick-in { padding: 12px; width: 80%; border-radius: 10px; border: 2px solid var(--gold); background: #34495e; color: white; font-size: 16px; margin-bottom: 20px; }

        @media (max-width: 768px) {
            .table { width: 95vw; height: 95vw; border-width: 6px; }
            .player { width: 280px; }
            .p-1 { left: -110px; }
            .p-3 { right: -110px; }
            .card { width: 45px; height: 70px; font-size: 24px; }
            .slot .revealed-card { width: 45px; height: 70px; font-size: 24px; }
            .hand { gap: 3px; min-height: 90px; }
            .controls { bottom: 20px; right: 0; left: 0; display: flex; justify-content: center; }
            #main-btn { width: 80%; padding: 20px; font-size: 22px; border-radius: 40px; }
            .slot-0 { bottom: 160px; }
            .slot-2 { top: 160px; }
            #rule-btn { top: auto; bottom: 100px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); }
        }
    </style>
</head>
<body>

<button id="rule-btn" onclick="toggleRules(true)">ğŸ“– éŠæˆ²è¦å‰‡</button>

<div id="rule-modal" onclick="toggleRules(false)">
    <div class="rule-content" onclick="event.stopPropagation()">
        <h3 style="color:var(--gold); margin-top:0; text-align:center;">ğŸ´ è±¡æ£‹åƒå¢©è¦å‰‡èªªæ˜</h3>
        <div style="text-align: left; max-height: 400px; overflow-y: auto;">
            <p><b>â— å«ç‰Œèˆ‡ç‰Œå‹ï¼š</b>é¦–å®¶æ“²éª°æ±ºå®šã€‚åˆæ³•ç‰Œå‹å«å–®å¼µã€å°å­ã€åŒå­(å¤šéš»å…µ/å’)ã€æˆ–ç‰¹å®šé †å­(å°‡å£«è±¡/è»Šé¦¬åŒ…é¡)ã€‚é †å­åƒ…éœ€å«ä¸‰ç¨®ä¸»ç‰Œï¼Œå¯åŠ å…¥é‡è¤‡ç‰Œé”æˆã€ŒXé †å­ã€ï¼Œå¦‚ï¼šä¿¥ç‘ªç‘ªç ²(å››é †å­)ï¼Œæœ€é«˜å…­é †å­ã€‚</p>
            <p><b>â— è·Ÿç‰Œå‹è² ï¼š</b>éœ€è·Ÿéš¨ç›¸åŒå¼µæ•¸èˆ‡ç‰Œå‹ã€‚<b>ç´…è‰²ç‰Œ > é»‘è‰²ç‰Œ</b>ï¼ˆå¦‚ç´…å…µå°å¤§æ–¼é»‘å’å°ï¼‰ã€‚å¤§ç‰Œè€…å¾—å¢©ä¸¦ç²å¾—ä¸‹è¼ªæ§ç‰Œæ¬Šã€‚</p>
            <p><b>â— çµç®—åŸºæº–ï¼š</b>æ¯å±€8å¢©ï¼Œ5å¢©ç‚ºåŸºæº–ï¼Œæ¯å¢©åŸºç¤20åˆ†ã€‚æœ«è¼ªè´å®¶ç‚ºçµç®—è€…ï¼Œå…¶é¤˜ä¸‰å®¶è‹¥ä½æ–¼åŸºæº–éœ€æ”¯ä»˜é‡‘é¡çµ¦çµç®—è€…ã€‚</p>
            <p><b>â— å…¨å£˜æ‰“ï¼š</b>å–®ä¸€ç©å®¶è´ä¸‹å…¨éƒ¨ 8 å¢©ï¼Œå…¶é¤˜ç©å®¶éœ€æ”¯ä»˜<b>é›™å€é‡‘é¡</b>çµ¦è©²ç©å®¶ã€‚</p>
        </div>
        <button onclick="toggleRules(false)" style="width:100%; padding:10px; margin-top:15px;">å›åˆ°ç‰Œæ¡Œ</button>
    </div>
</div>

<div id="timer-box" style="position:absolute; top:20px; right:20px; font-size:36px; font-weight:bold; color:#e74c3c; background:rgba(0,0,0,0.6); padding:5px 20px; border-radius:10px; display:none; z-index: 10002;">30</div>
<div id="toast" style="position:fixed; top:20%; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.9); color:var(--gold); padding:15px 30px; border:2px solid var(--gold); border-radius:10px; display:none; z-index:99999; font-size:20px; font-weight:bold;"></div>

<div id="lobby" style="position:absolute; width:320px; background:#2c3e50; padding:30px; border-radius:20px; text-align:center; border:3px solid var(--gold); z-index:10001;">
    <h2 style="color:var(--gold);">è±¡æ£‹åƒå¢© PVP</h2>
    <div id="lobby-init-name">
        <input type="text" id="nick-in" placeholder="è«‹è¼¸å…¥æ‚¨çš„æš±ç¨±" maxlength="10">
        <div id="lobby-ops">
            <button id="btn-host" onclick="createRoom()" style="width:100%;">å‰µå»ºæˆ¿é–“</button>
            <button id="btn-join" onclick="joinRoomAction()" style="width:100%; display:none; margin-top:10px; background:#27ae60;">åŠ å…¥éŠæˆ²</button>
        </div>
    </div>
    <div id="lobby-status" style="display:none;">
        <p id="player-count">(1/4)</p>
        <div id="player-list" style="margin:15px 0; text-align:left; color:#ecf0f1; padding-left:20px;"></div>
        <input type="text" id="copy-url" readonly onclick="this.select();" style="width:100%; padding:8px; text-align:center; margin-top:10px; background:#34495e; color:white; border:none;">
        <button id="btn-roll" onclick="hostRollDice()" style="margin-top:20px; display:none; width:100%;">ğŸ² æ“²éª°æ±ºå®šé¦–å®¶</button>
    </div>
</div>

<div id="settlement-overlay">
    <div style="background:#2c3e50; border:3px solid var(--gold); padding:30px; border-radius:15px; width:85%; max-width:420px; text-align:center;">
        <h2 style="color:var(--gold);">æœ¬å±€çµç®—</h2>
        <div id="last-winner-info" style="color:white; margin-bottom:15px; font-weight:bold;"></div>
        <div id="result-list"></div>
        <button onclick="requestNextGame()" style="margin-top:20px; width:100%;">ä¸‹ä¸€å±€éŠæˆ²</button>
    </div>
</div>

<div class="table" id="main-table">
    <div id="area-0" class="player p-0"><div id="t-0" class="tricks"></div><div id="h-0" class="hand"></div><div><b id="name-0">å—</b><div id="status-0" style="height:20px; color:var(--gold);"></div><div id="bal-0">$5000</div></div></div>
    <div id="area-1" class="player p-1"><div><b id="name-1">è¥¿</b><div id="status-1" style="height:20px; color:var(--gold);"></div><div id="bal-1">$5000</div></div><div id="h-1" class="hand"></div><div id="t-1" class="tricks"></div></div>
    <div id="area-2" class="player p-2"><div><b id="name-2">åŒ—</b><div id="status-2" style="height:20px; color:var(--gold);"></div><div id="bal-2">$5000</div></div><div id="h-2" class="hand"></div><div id="t-2" class="tricks"></div></div>
    <div id="area-3" class="player p-3"><div><b id="name-3">æ±</b><div id="status-3" style="height:20px; color:var(--gold);"></div><div id="bal-3">$5000</div></div><div id="h-3" class="hand"></div><div id="t-3" class="tricks"></div></div>
    <div id="slot-0" class="slot slot-0"></div><div id="slot-1" class="slot slot-1"></div>
    <div id="slot-2" class="slot slot-2"></div><div id="slot-3" class="slot slot-3"></div>
</div>

<div class="controls" style="position:absolute; bottom:30px; right:30px;"><button id="main-btn" onclick="flow()" disabled>ç­‰å¾…ä¸­</button></div>

<script>
    function toggleRules(show) { document.getElementById('rule-modal').style.display = show ? 'flex' : 'none'; }

    const CHESS_DATA = [
        {n:'å¸¥', v:7, r:true}, {n:'ä»•', v:6, r:true}, {n:'ä»•', v:6, r:true}, {n:'ç›¸', v:5, r:true}, {n:'ç›¸', v:5, r:true},
        {n:'ä¿¥', v:4, r:true}, {n:'ä¿¥', v:4, r:true}, {n:'ç‘ª', v:3, r:true}, {n:'ç‘ª', v:3, r:true}, {n:'ç ²', v:2, r:true}, {n:'ç ²', v:2, r:true},
        {n:'å…µ', v:1, r:true}, {n:'å…µ', v:1, r:true}, {n:'å…µ', v:1, r:true}, {n:'å…µ', v:1, r:true}, {n:'å…µ', v:1, r:true},
        {n:'å°‡', v:7, r:false}, {n:'å£«', v:6, r:false}, {n:'å£«', v:6, r:false}, {n:'è±¡', v:5, r:false}, {n:'è±¡', v:5, r:false},
        {n:'è»Š', v:4, r:false}, {n:'è»Š', v:4, r:false}, {n:'é¦¬', v:3, r:false}, {n:'é¦¬', v:3, r:false}, {n:'åŒ…', v:2, r:false}, {n:'åŒ…', v:2, r:false},
        {n:'å’', v:1, r:false}, {n:'å’', v:1, r:false}, {n:'å’', v:1, r:false}, {n:'å’', v:1, r:false}, {n:'å’', v:1, r:false}
    ];

    let peer = null, connections = [], hostConn = null, isHost = false, myIndex = -1;
    let balances = [5000, 5000, 5000, 5000], hands = [[],[],[],[]], trickHistory = [[],[],[],[]];
    let selectedIDs = [], confirmedIDs = [], state = "IDLE", turn = 0, currentCall = null;
    let tableCards = [[],[],[],[]], hasConfirmed = [false, false, false, false], timerInterval = null;
    let names = ["","","",""];

    const rid = (new URLSearchParams(window.location.search)).get('room');
    if (rid) {
        document.getElementById('btn-host').style.display = 'none';
        document.getElementById('btn-join').style.display = 'block';
    }

    function getPattern(cards) {
        if (!cards || cards.length === 0) return null;
        const len = cards.length;
        const isAllRed = cards.every(c => c.r);
        const isAllBlack = cards.every(c => !c.r);
        if (!isAllRed && !isAllBlack) return null;
        const ns = cards.map(c => c.n);
        const vSum = cards.reduce((s, c) => s + c.v + (c.r ? 0.5 : 0), 0); // åŠ å¤§ç´…ç‰Œæ¬Šé‡ (0.5 > 0)
        if (len === 1) return { name: "å–®", pwr: vSum };
        if ([...new Set(ns)].length === 1 && len >= 2) return { name: "åŒå­", pwr: 1000 * len + vSum };
        const groupA = isAllRed ? ['å¸¥', 'ä»•', 'ç›¸'] : ['å°‡', 'å£«', 'è±¡'];
        const groupB = isAllRed ? ['ä¿¥', 'ç‘ª', 'ç ²'] : ['è»Š', 'é¦¬', 'åŒ…'];
        const hasA = groupA.every(name => ns.includes(name));
        const onlyA = ns.every(name => groupA.includes(name));
        const hasB = groupB.every(name => ns.includes(name));
        const onlyB = ns.every(name => groupB.includes(name));
        if ((hasA && onlyA) || (hasB && onlyB)) return { name: "é †å­", pwr: 2000 * len + vSum };
        return null;
    }

    function createRoom() {
        const myName = document.getElementById('nick-in').value || "æˆ¿ä¸»";
        names[0] = myName; myIndex = 0; isHost = true;
        peer = new Peer();
        document.getElementById('lobby-init-name').style.display = 'none';
        document.getElementById('lobby-status').style.display = 'block';
        peer.on('open', (id) => {
            document.getElementById('copy-url').value = window.location.origin + window.location.pathname + "?room=" + id;
            updateLobbyNames();
        });
        peer.on('connection', (conn) => {
            if (connections.length >= 3) return conn.close();
            connections.push(conn);
            conn.on('open', () => {
                conn.on('data', (d) => handleData(d, connections.indexOf(conn) + 1));
            });
        });
    }

    function joinRoomAction() {
        const myName = document.getElementById('nick-in').value || "ç©å®¶";
        isHost = false; peer = new Peer();
        peer.on('open', () => {
            hostConn = peer.connect(rid);
            hostConn.on('open', () => {
                hostConn.send({type: 'JOIN', name: myName});
                hostConn.on('data', (d) => handleData(d, 0));
            });
        });
    }

    function updateLobbyNames() {
        if (!isHost) return;
        const activeNames = names.filter(n => n !== "");
        document.getElementById('player-count').innerText = `(${activeNames.length}/4)`;
        document.getElementById('player-list').innerHTML = activeNames.map(n => `<div>â€¢ ${n}</div>`).join('');
        if (activeNames.length === 4) document.getElementById('btn-roll').style.display = 'block';
        broadcast({type: 'LOBBY_SYNC', names: names, count: activeNames.length});
    }

    function hostRollDice() {
        const startIdx = Math.floor(Math.random() * 4);
        broadcast({type: 'MSG', msg: `ğŸ² æ“²éª°çµæœï¼šé¦–å®¶ç‚º ${names[startIdx]}`});
        setTimeout(() => serverInitGame(startIdx), 1500);
    }

    function handleData(data, senderIdx) {
        if (data.type === 'JOIN' && isHost) { names[senderIdx] = data.name; updateLobbyNames(); }
        if (data.type === 'LOBBY_SYNC') {
            names = data.names;
            document.getElementById('lobby-init-name').style.display = 'none';
            document.getElementById('lobby-status').style.display = 'block';
            document.getElementById('player-count').innerText = `(${data.count}/4)`;
            document.getElementById('player-list').innerHTML = names.filter(n => n !== "").map(n => `<div>â€¢ ${n}</div>`).join('');
        }
        if (data.type === 'INIT') {
            myIndex = data.index;
            document.getElementById('lobby').style.display = 'none';
            document.getElementById('main-table').style.display = 'block';
            resetRoundState(); render();
        }
        if (data.type === 'DISTRIBUTE') {
            document.getElementById('settlement-overlay').style.display = 'none';
            resetRoundState(); hands = data.hands; sortHand(); render();
        }
        if (data.type === 'SYNC') {
            turn = data.turn; currentCall = data.currentCall;
            hasConfirmed = data.hasConfirmed; 
            if (currentCall === null) state = (turn === myIndex) ? "MY_TURN" : "IDLE";
            else state = hasConfirmed[myIndex] ? "WAITING" : "FOLLOWING";
            document.getElementById('timer-box').style.display = currentCall ? 'block' : 'none';
            render();
        }
        if (data.type === 'CONFIRM_OK') {
            hasConfirmed[data.idx] = true;
            if (data.idx === myIndex) { confirmedIDs = [...selectedIDs]; selectedIDs = []; state = "WAITING"; }
            const uiIdx = (data.idx - myIndex + 4) % 4;
            document.getElementById(`slot-${uiIdx}`).innerHTML = Array(data.cardCount).fill('<div class="p-card" style="width:32px; height:48px; background:var(--card-back); border-radius:3px; border:1px solid white;"></div>').join('');
            render();
        }
        if (data.type === 'FORCE_BATTLE') {
            state = "ANIMATING";
            tableCards = data.tableCards; 
            for(let i=0; i<4; i++) {
                const ids = tableCards[i].map(c => c.id);
                hands[i] = hands[i].filter(card => !ids.includes(card.id));
            }
            trickHistory[data.winIdx].push(...data.wonCards);
            runBattleAnimation(data.winIdx, data.callerIdx);
        }
        if (data.type === 'PLAY_ACTION' && isHost) serverReceiveAction(senderIdx, data.cards);
        if (data.type === 'SETTLE_ALL') { 
            balances = data.balances; 
            showSettle(data.diffs, data.counts, data.lastWinner); 
        }
        if (data.type === 'MSG') showToast(data.msg);
        if (data.type === 'TIMER') document.getElementById('timer-box').innerText = data.time;
        if (data.type === 'REQ_NEXT' && isHost) serverStartRound();
    }

    function broadcast(data) {
        if (isHost) { connections.forEach(c => c.send(data)); handleData(data, 0); }
        else hostConn.send(data);
    }

    function serverInitGame(startTurn) {
        broadcast({type: 'INIT', index: 0});
        connections.forEach((c, i) => c.send({type: 'INIT', index: i+1}));
        setTimeout(() => serverStartRound(startTurn), 500);
    }

    function serverStartRound(forcedStart) {
        let deck = [...CHESS_DATA].map(c => ({...c, id: Math.random()})).sort(() => Math.random() - 0.5);
        let startTurn = (forcedStart !== undefined) ? forcedStart : Math.floor(Math.random() * 4);
        let tempHands = [[],[],[],[]];
        for(let r=0; r<8; r++) for(let i=0; i<4; i++) tempHands[(startTurn+i)%4].push(deck.pop());
        broadcast({type: 'DISTRIBUTE', hands: tempHands});
        turn = startTurn;
        serverSyncLocal();
    }

    function serverSyncLocal() { broadcast({type: 'SYNC', turn: turn, currentCall: currentCall, hasConfirmed: hasConfirmed}); }

    function serverReceiveAction(idx, cards) {
        if (hasConfirmed[idx]) return;
        tableCards[idx] = cards;
        hasConfirmed[idx] = true;
        broadcast({type: 'CONFIRM_OK', idx: idx, cardCount: cards.length});
        if (currentCall === null) {
            let pat = getPattern(cards);
            currentCall = {...pat, count: cards.length, callerIdx: idx};
            startTimerHost();
            serverSyncLocal();
        } 
        if (hasConfirmed.every(v => v === true)) {
            if (timerInterval) clearInterval(timerInterval);
            serverProcessBattle();
        }
    }

    function serverProcessBattle() {
        let winIdx = currentCall.callerIdx, maxPwr = currentCall.pwr;
        for(let i=0; i<4; i++) {
            let pPat = getPattern(tableCards[i]);
            if (tableCards[i].length === currentCall.count && pPat && pPat.name === currentCall.name) {
                if (pPat.pwr > maxPwr) { maxPwr = pPat.pwr; winIdx = i; }
            }
        }
        let wonCards = [...tableCards[winIdx]]; 
        broadcast({type: 'FORCE_BATTLE', tableCards, winIdx, callerIdx: currentCall.callerIdx, wonCards: wonCards});
        setTimeout(() => {
            if (hands[0].length === 0) serverFinalSettle(winIdx);
            else { turn = winIdx; currentCall = null; hasConfirmed = [false, false, false, false]; serverSyncLocal(); }
        }, 4000);
    }

    function startTimerHost() {
        let t = 30; if (timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            t--; broadcast({type: 'TIMER', time: t});
            if (t <= 0) {
                clearInterval(timerInterval);
                for(let i=0; i<4; i++) if(!hasConfirmed[i]) serverReceiveAction(i, [hands[i][0]]);
            }
        }, 1000);
    }

    function serverFinalSettle(lastWinnerIdx) {
        let diffs = [0,0,0,0];
        let finalCounts = trickHistory.map(h => h.length); 
        let baseTricks = 5, perTrickRate = 20, totalFlow = 0;
        
        // æª¢æŸ¥æ˜¯å¦æœ‰å…¨å£˜æ‰“
        let slamWinner = finalCounts.findIndex(c => c === 8);
        if (slamWinner !== -1) {
            for(let i=0; i<4; i++) {
                if(i !== slamWinner) {
                    diffs[i] = -60 * 2; // (5-8)*20 * 2å€ = -120
                    totalFlow += diffs[i];
                }
            }
            diffs[slamWinner] = -totalFlow;
        } else {
            // æ™®é€šçµç®—ï¼šæœ€å¾Œä¸€è¼ªè´å®¶ç‚ºçµç®—è€… (lastWinnerIdx)
            for(let i=0; i<4; i++) {
                if (i !== lastWinnerIdx) {
                    let d = (finalCounts[i] - baseTricks) * perTrickRate;
                    diffs[i] = d;
                    totalFlow += d;
                }
            }
            diffs[lastWinnerIdx] = -totalFlow;
        }
        
        for(let i=0; i<4; i++) balances[i] += diffs[i];
        broadcast({type: 'SETTLE_ALL', balances, diffs, counts: finalCounts, lastWinner: names[lastWinnerIdx]});
    }

    function sortHand() { hands[myIndex].sort((a,b) => (b.v !== a.v) ? b.v - a.v : (b.r ? -1 : 1)); }

    function flow() {
        if (state === "WAITING" || state === "ANIMATING") return;
        const played = hands[myIndex].filter(c => selectedIDs.includes(c.id));
        if (state === "MY_TURN") {
            if (!getPattern(played)) return showToast("âŒ ç‰Œå‹ç„¡æ•ˆ");
            broadcast({type: 'PLAY_ACTION', cards: played});
        } else if (state === "FOLLOWING") {
            if (played.length !== currentCall.count) return showToast(`âŒ éœ€å‡º ${currentCall.count} å¼µ`);
            broadcast({type: 'PLAY_ACTION', cards: played});
        }
    }

    function render() {
        const btn = document.getElementById('main-btn');
        const countNeeded = currentCall ? currentCall.count : 0;
        const canSubmit = (state === "MY_TURN" && selectedIDs.length > 0) || (state === "FOLLOWING" && selectedIDs.length === countNeeded);
        btn.disabled = !canSubmit || state === "WAITING" || state === "ANIMATING";
        btn.innerText = (state === "WAITING") ? "ç­‰å¾…ä¸­..." : (state === "MY_TURN") ? "ç¢ºèªå«ç‰Œ" : (state === "FOLLOWING") ? "ç¢ºèªè·Ÿç‰Œ" : "ç­‰å¾…ä¸­";

        for(let i=0; i<4; i++) {
            let wIdx = (i + myIndex) % 4;
            document.getElementById(`name-${i}`).innerText = names[wIdx] || "ç­‰å¾…ä¸­";
            document.getElementById(`area-${i}`).classList.toggle('active-glow', wIdx === turn);
            document.getElementById(`bal-${i}`).innerText = `$${balances[wIdx]}`;
            document.getElementById(`status-${i}`).innerText = (wIdx === turn && !currentCall) ? "å«ç‰Œä¸­..." : (currentCall && !hasConfirmed[wIdx]) ? "è·Ÿç‰Œä¸­..." : (hasConfirmed[wIdx]) ? "âœ“ å·²å°±ç·’" : "";
            const h = document.getElementById(`h-${i}`); h.innerHTML = '';
            if (wIdx === myIndex) {
                hands[wIdx].forEach(c => {
                    const d = document.createElement('div');
                    d.className = `card ${c.r?'red-p':''} ${selectedIDs.includes(c.id)?'selected':''} ${confirmedIDs.includes(c.id)?'confirmed':''}`;
                    d.innerText = c.n; d.onclick = () => {
                        if (state === "ANIMATING" || hasConfirmed[myIndex]) return;
                        if (selectedIDs.includes(c.id)) selectedIDs = selectedIDs.filter(id => id !== c.id);
                        else if (selectedIDs.length < (currentCall ? currentCall.count : 8)) selectedIDs.push(c.id);
                        render();
                    }; h.appendChild(d);
                });
            } else hands[wIdx].forEach(() => h.innerHTML += '<div class="card back"></div>');
            const t = document.getElementById(`t-${i}`); t.innerHTML = '';
            trickHistory[wIdx].forEach(card => {
                const tag = document.createElement('div');
                tag.className = `trick-tag ${card.r ? 'red-p' : ''}`;
                tag.innerText = card.n;
                t.appendChild(tag);
            });
        }
    }

    async function runBattleAnimation(winIdx, callerIdx) {
        let currentMaxPwr = -1;
        for(let i=0; i<4; i++) {
            let p = (callerIdx + i) % 4;
            const sIdx = (p - myIndex + 4) % 4;
            let pPat = getPattern(tableCards[p]);
            let shouldReveal = (i === 0) || (tableCards[p].length === currentCall.count && pPat && pPat.pwr > currentMaxPwr);
            if (shouldReveal) currentMaxPwr = pPat ? pPat.pwr : currentMaxPwr;
            document.getElementById(`slot-${sIdx}`).innerHTML = tableCards[p].map(c => `
                <div class="revealed-card ${shouldReveal ? (c.r?'red-p':'') : 'hidden-win'}">${shouldReveal ? c.n : ''}</div>
            `).join('');
            await new Promise(r => setTimeout(r, 700));
        }
        await new Promise(r => setTimeout(r, 1500));
        for(let i=0; i<4; i++) document.getElementById(`slot-${i}`).innerHTML = '';
        render();
    }

    function resetRoundState() {
        trickHistory=[[],[],[],[]]; selectedIDs=[]; confirmedIDs=[]; currentCall=null;
        tableCards=[[],[],[],[]]; hasConfirmed=[false,false,false,false];
        for(let i=0; i<4; i++) document.getElementById(`slot-${i}`).innerHTML = '';
    }

    function showToast(m) {
        const t = document.getElementById('toast'); t.innerText = m; t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 3000);
    }

    function showSettle(diffs, counts, lastWinnerName) {
        document.getElementById('last-winner-info').innerText = `ğŸ† æœ€å¾Œä¸€å¢©è´å®¶ï¼š${lastWinnerName}`;
        const list = document.getElementById('result-list'); list.innerHTML = '';
        for(let i=0; i<4; i++) {
            const wIdx = (i + myIndex) % 4;
            list.innerHTML += `<div style="display:flex; justify-content:space-between; margin:8px 0; color:white;">
                <span>${names[wIdx]} (å¾— ${counts[wIdx]} å¢©)</span>
                <span style="color:${diffs[wIdx]>=0?'#2ecc71':'#e74c3c'}">${diffs[wIdx]>=0?'+':''}${diffs[wIdx]}</span>
            </div>`;
        }
        document.getElementById('settlement-overlay').style.display = 'flex';
    }

    function requestNextGame() { if (isHost) serverStartRound(); else hostConn.send({type: 'REQ_NEXT'}); }
</script>
</body>
</html>
