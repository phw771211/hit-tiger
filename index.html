<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è±¡æ£‹åƒå¢© PVP - Milestone 1.3 (Fixed V9)</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --gold: #f1c40f; --red: #e74c3c; --table: #2e7d32; --card-back: #2c3e50; }
        * { box-sizing: border-box; }
        body { background: #1a1a1a; color: white; font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; overflow: hidden; }
        
        /* è¦å‰‡å½ˆçª—æ¨£å¼ */
        #rule-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.85); display: none; justify-content: center; align-items: center; z-index: 100000; padding: 20px; }
        .rule-content { background: #2c3e50; border: 3px solid var(--gold); border-radius: 20px; padding: 25px; max-width: 550px; max-height: 85vh; overflow-y: auto; text-align: left; line-height: 1.6; font-size: 15px; }
        .rule-content h3 { color: var(--gold); margin-top: 0; text-align: center; border-bottom: 2px solid var(--gold); padding-bottom: 10px; }
        .rule-content p { margin: 15px 0; }
        .rule-content b { color: var(--gold); }
        
        .table-container { width: 700px; height: 700px; display: flex; justify-content: center; align-items: center; }
        @media (max-width: 750px) { .table-container { transform: scale(0.5); } }
        @media (max-width: 400px) { .table-container { transform: scale(0.42); } }
        
        .table { width: 700px; height: 700px; background: var(--table); border: 12px solid #5d4037; border-radius: 50%; position: relative; box-shadow: inset 0 0 100px #000; display: none; }
        .player { position: absolute; text-align: center; width: 360px; z-index: 10; padding: 10px; border-radius: 15px; border: 2px solid transparent; transition: all 0.3s; }
        .p-0 { bottom: 10px; left: 50%; transform: translateX(-50%); }
        .p-1 { left: -140px; top: 50%; transform: translateY(-50%) rotate(90deg); }
        .p-2 { top: 10px; left: 50%; transform: translateX(-50%) rotate(180deg); }
        .p-3 { right: -140px; top: 50%; transform: translateY(-50%) rotate(-90deg); }
        .info-container { transform: rotate(0deg); }
        .p-1 .info-container { transform: rotate(-90deg); }
        .p-2 .info-container { transform: rotate(-180deg); }
        .p-3 .info-container { transform: rotate(90deg); }
        
        .active-glow { background: rgba(241, 196, 15, 0.25); border: 2px solid var(--gold) !important; box-shadow: 0 0 20px var(--gold); }
        .hand { display: flex; gap: 5px; justify-content: center; min-height: 80px; margin-top: 5px; flex-wrap: nowrap; }
        .card { width: 40px; height: 60px; background: white; color: black; border-radius: 4px; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 20px; border: 2px solid #333; cursor: pointer; transition: transform 0.2s; }
        .card.red-p { color: var(--red); border-color: var(--red); }
        .card.selected { transform: translateY(-18px); border: 3px solid var(--gold); box-shadow: 0 5px 15px var(--gold); }
        .card.confirmed { opacity: 0.4; filter: grayscale(0.8); transform: translateY(-12px); cursor: default; }
        .card.back { background: var(--card-back) !important; color: transparent !important; border-color: #fff; }
        
        .slot { position: absolute; width: 150px; height: 110px; display: flex; justify-content: center; align-items: center; gap: 4px; background: rgba(0,0,0,0.15); border: 2px dashed rgba(255,255,255,0.2); border-radius: 10px; }
        .slot-0 { bottom: 200px; left: 50%; transform: translateX(-50%); }
        .slot-1 { left: 160px; top: 50%; transform: translateY(-50%) rotate(90deg); }
        .slot-2 { top: 200px; left: 50%; transform: translateX(-50%) rotate(180deg); }
        .slot-3 { right: 160px; top: 50%; transform: translateY(-50%) rotate(-90deg); }
        
        .tricks { display: flex; gap: 2px; height: 25px; justify-content: center; margin-bottom: 5px; }
        .trick-tag { width: 22px; height: 22px; background: #fff; color: #000; font-size: 13px; font-weight: bold; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 1px solid #333; }
        .trick-tag.red-p { color: var(--red); border-color: var(--red); }
        
        #lobby, #settlement-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.92); display: flex; justify-content: center; align-items: center; z-index: 10001; }
        .panel { background: #2c3e50; padding: 30px; border-radius: 20px; border: 3px solid var(--gold); width: 340px; text-align: center; }
        button { padding: 12px 25px; background: #e67e22; color: white; border: none; border-radius: 30px; cursor: pointer; font-weight: bold; font-size: 16px; margin: 5px 0; }
        button:disabled { background: #7f8c8d; cursor: not-allowed; }
        
        #toast { position:fixed; top:20%; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.9); color:var(--gold); padding:15px 30px; border:2px solid var(--gold); border-radius:10px; display:none; z-index:99999; }
        #timer-box { position:absolute; top:20px; right:20px; font-size:36px; font-weight:bold; color:#e74c3c; display:none; z-index:10002; }
        .rule-btn { position: fixed; top: 20px; left: 20px; z-index: 10005; background: #3498db; }
    </style>
</head>
<body>

<div id="toast"></div>
<div id="timer-box">30</div>
<button class="rule-btn" onclick="toggleRules()">ğŸ’¡ éŠæˆ²è¦å‰‡</button>

<div id="rule-overlay" onclick="toggleRules()">
    <div class="rule-content" onclick="event.stopPropagation()">
        <h3>è±¡æ£‹åƒå¢© éŠæˆ²è¦å‰‡</h3>
        <p><b>â— å«ç‰Œèˆ‡ç‰Œå‹ï¼š</b><br>é¦–å®¶æ“²éª°æ±ºå®šã€‚åˆæ³•ç‰Œå‹å«å–®å¼µã€å°å­ã€åŒå­(å¤šå…µ/å’)åŠé †å­(å°‡å£«è±¡/è»Šé¦¬åŒ…é¡)ã€‚é †å­å¯åŒ…å«é‡è¤‡ç‰Œï¼Œå¦‚ã€Œå°‡å£«å£«è±¡ã€æˆ–ã€Œä¿¥ä¿¥ç‘ªç‘ªç ²ç ²ã€ã€‚</p>
        <p><b>â— è·Ÿç‰Œå‹è² ï¼š</b><br>é ˆè·Ÿå¼µæ•¸èˆ‡ç‰Œå‹ã€‚ç´…ç‰Œ > é»‘ç‰Œï¼ˆå¦‚å…µå°å‹å’å°ï¼‰ã€‚å¤§ç‰Œè€…å¾—å¢©ä¸¦ç²ä¸‹è¼ªå«ç‰Œæ¬Šã€‚</p>
        <p><b>â— çµç®—èˆ‡å…¨å£˜æ‰“ï¼š</b><br>ä»¥ 5 å¢©ç‚ºåŸºæº–ï¼Œæ¯å¢© 20 åˆ†ã€‚æœ€çµ‚å›åˆè´å®¶ç‚ºçµç®—è€…ã€‚è‹¥é”æˆ 8 å¢©å…¨å£˜æ‰“ï¼Œå…¶é¤˜ç©å®¶æ”¯ä»˜é›™å€ã€‚</p>
        <center><button onclick="toggleRules()" style="background:var(--gold); color:black; margin-top:10px; width:120px;">æˆ‘æ˜ç™½äº†</button></center>
    </div>
</div>

<div id="lobby">
    <div class="panel">
        <h2 style="color:var(--gold);">è±¡æ£‹åƒå¢© PVP</h2>
        <div id="lobby-init-name">
            <input type="text" id="nick-in" placeholder="è«‹è¼¸å…¥æš±ç¨±" maxlength="10" style="padding:12px; width:100%; border-radius:10px; border:2px solid var(--gold); background:#34495e; color:white; margin-bottom:10px;">
            <button id="btn-host" onclick="createRoom()" style="width:100%;">å‰µå»ºæˆ¿é–“</button>
            <button id="btn-join" onclick="joinRoomAction()" style="width:100%; display:none; background:#27ae60;">åŠ å…¥éŠæˆ²</button>
            <button onclick="toggleRules()" style="width:100%; background:#7f8c8d;">æŸ¥çœ‹è¦å‰‡</button>
        </div>
        <div id="lobby-status" style="display:none;">
            <p id="player-count" style="font-size:20px; color:var(--gold); font-weight:bold;">(1/4)</p>
            <div id="player-list" style="margin:20px 0; text-align:left; background:rgba(0,0,0,0.3); padding:15px; border-radius:10px; min-height:100px;"></div>
            <input type="text" id="copy-url" readonly onclick="this.select();" style="width:100%; padding:8px; font-size:12px; background:#1a1a1a; color:#aaa; border:1px solid #444; margin-bottom:10px;">
            <p id="wait-msg">ç­‰å¾…å…¶ä»–ç©å®¶åŠ å…¥...</p>
        </div>
    </div>
</div>

<div id="settlement-overlay" style="display:none;">
    <div class="panel">
        <h2 style="color:var(--gold);">æœ¬å±€çµç®—</h2>
        <div id="last-winner-info" style="font-weight:bold; margin-bottom:10px;"></div>
        <div id="result-list"></div>
        <button id="btn-next-ready" style="margin-top:20px; width:100%;">ä¸‹ä¸€å±€éŠæˆ²</button>
    </div>
</div>

<div class="table-container">
    <div class="table" id="main-table">
        <div id="area-0" class="player p-0"><div id="t-0" class="tricks"></div><div id="h-0" class="hand"></div><div class="info-container"><b id="name-0"></b><div id="status-0" style="color:var(--gold); font-size:12px; height:15px;"></div><div id="bal-0"></div></div></div>
        <div id="area-1" class="player p-1"><div class="info-container"><b id="name-1"></b><div id="status-1" style="color:var(--gold); font-size:12px; height:15px;"></div><div id="bal-1"></div></div><div id="h-1" class="hand"></div><div id="t-1" class="tricks"></div></div>
        <div id="area-2" class="player p-2"><div class="info-container"><b id="name-2"></b><div id="status-2" style="color:var(--gold); font-size:12px; height:15px;"></div><div id="bal-2"></div></div><div id="h-2" class="hand"></div><div id="t-2" class="tricks"></div></div>
        <div id="area-3" class="player p-3"><div class="info-container"><b id="name-3"></b><div id="status-3" style="color:var(--gold); font-size:12px; height:15px;"></div><div id="bal-3"></div></div><div id="h-3" class="hand"></div><div id="t-3" class="tricks"></div></div>
        <div id="slot-0" class="slot slot-0"></div><div id="slot-1" class="slot slot-1"></div>
        <div id="slot-2" class="slot slot-2"></div><div id="slot-3" class="slot slot-3"></div>
    </div>
</div>

<div class="controls" style="position:fixed; bottom:30px; left:50%; transform:translateX(-50%);"><button id="main-btn" onclick="flow()" disabled style="padding:15px 50px; font-size:20px;">ç­‰å¾…ä¸­</button></div>

<script>
    // é‚è¼¯éƒ¨åˆ†èˆ‡ä¹‹å‰ç‰ˆæœ¬ç›¸åŒï¼Œç¢ºä¿ PVP èˆ‡ Milestone 1.2 è¦å‰‡å°é½Š
    const CHESS_DATA = [
        {n:'å¸¥', v:7, r:true}, {n:'ä»•', v:6, r:true}, {n:'ä»•', v:6, r:true}, {n:'ç›¸', v:5, r:true}, {n:'ç›¸', v:5, r:true},
        {n:'ä¿¥', v:4, r:true}, {n:'ä¿¥', v:4, r:true}, {n:'ç‘ª', v:3, r:true}, {n:'ç‘ª', v:3, r:true}, {n:'ç ²', v:2, r:true}, {n:'ç ²', v:2, r:true},
        {n:'å…µ', v:1, r:true}, {n:'å…µ', v:1, r:true}, {n:'å…µ', v:1, r:true}, {n:'å…µ', v:1, r:true}, {n:'å…µ', v:1, r:true},
        {n:'å°‡', v:7, r:false}, {n:'å£«', v:6, r:false}, {n:'å£«', v:6, r:false}, {n:'è±¡', v:5, r:false}, {n:'è±¡', v:5, r:false},
        {n:'è»Š', v:4, r:false}, {n:'è»Š', v:4, r:false}, {n:'é¦¬', v:3, r:false}, {n:'é¦¬', v:3, r:false}, {n:'åŒ…', v:2, r:false}, {n:'åŒ…', v:2, r:false},
        {n:'å’', v:1, r:false}, {n:'å’', v:1, r:false}, {n:'å’', v:1, r:false}, {n:'å’', v:1, r:false}, {n:'å’', v:1, r:false}
    ];

    let peer = null, connections = [], hostConn = null, isHost = false, myIndex = -1;
    let balances = [5000, 5000, 5000, 5000], hands = [[],[],[],[]], trickHistory = [[],[],[],[]];
    let selectedIDs = [], confirmedIDs = [], state = "IDLE", turn = 0, currentCall = null;
    let tableCards = [[],[],[],[]], hasConfirmed = [false, false, false, false], names = ["","","",""];
    let diceTurn = 0, isProcessing = false, roundWinners = [];

    const rid = (new URLSearchParams(window.location.search)).get('room');
    window.onload = () => { if (rid) { document.getElementById('btn-host').style.display = 'none'; document.getElementById('btn-join').style.display = 'block'; } };

    function toggleRules() { const el = document.getElementById('rule-overlay'); el.style.display = (el.style.display === 'flex') ? 'none' : 'flex'; }
    
    function createRoom() {
        const myName = document.getElementById('nick-in').value || "æˆ¿ä¸»";
        peer = new Peer(); isHost = true; myIndex = 0; names[0] = myName;
        peer.on('open', (id) => {
            document.getElementById('copy-url').value = location.origin + location.pathname + "?room=" + id;
            document.getElementById('lobby-init-name').style.display = 'none';
            document.getElementById('lobby-status').style.display = 'block';
            updateLobbyUI();
        });
        peer.on('connection', (conn) => {
            conn.on('open', () => {
                conn.on('data', (d) => {
                    if (d.type === 'JOIN') {
                        let nIdx = names.indexOf("");
                        if (nIdx !== -1) {
                            names[nIdx] = d.name; connections[nIdx] = conn;
                            broadcast({type: 'LOBBY_SYNC', names}); 
                            updateLobbyUI();
                        }
                    } else handleData(d, names.indexOf(d.senderName));
                });
            });
        });
    }

    function joinRoomAction() {
        const myName = document.getElementById('nick-in').value || "ç©å®¶";
        peer = new Peer();
        peer.on('open', (id) => {
            hostConn = peer.connect(rid);
            hostConn.on('open', () => {
                hostConn.send({type: 'JOIN', name: myName});
                document.getElementById('lobby-init-name').style.display = 'none';
                document.getElementById('lobby-status').style.display = 'block';
                hostConn.on('data', (d) => handleData(d, 0));
            });
        });
    }

    function updateLobbyUI() {
        const count = names.filter(n => n !== "").length;
        document.getElementById('player-count').innerText = `(${count}/4)`;
        document.getElementById('player-list').innerHTML = names.filter(n => n !== "").map(n => `<div style="padding:8px; border-bottom:1px solid #444; font-weight:bold;">â€¢ ${n}</div>`).join('');
        if (isHost && count === 4) {
            let deck = [...CHESS_DATA].map(c => ({...c, id: Math.random()})).sort(() => Math.random() - 0.5);
            let gameHands = [[],[],[],[]];
            for(let r=0; r<8; r++) for(let i=0; i<4; i++) gameHands[i].push(deck.pop());
            setTimeout(() => {
                for(let i=0; i<4; i++) {
                    const payload = {type: 'INIT', index: i, names, state: "WAIT_DICE", diceTurn: 0, hands: gameHands};
                    if (i === 0) handleData(payload, 0); else connections[i].send(payload);
                }
            }, 1000);
        }
    }

    function handleData(data, senderIdx) {
        if (data.type === 'LOBBY_SYNC') { names = data.names; updateLobbyUI(); }
        if (data.type === 'INIT') {
            myIndex = data.index; names = data.names; state = data.state; diceTurn = data.diceTurn; hands = data.hands;
            sortHand(); document.getElementById('lobby').style.display = 'none'; document.getElementById('main-table').style.display = 'block'; render();
        }
        if (data.type === 'SYNC') {
            state = "PLAYING"; turn = data.turn; currentCall = data.currentCall; hasConfirmed = data.hasConfirmed; 
            state = (currentCall === null) ? (turn === myIndex ? "MY_TURN" : "IDLE") : (hasConfirmed[myIndex] ? "WAITING" : "FOLLOWING");
            document.getElementById('timer-box').style.display = currentCall ? 'block' : 'none';
            render();
        }
        if (data.type === 'CONFIRM_OK') {
            hasConfirmed[data.idx] = true; if (data.idx === myIndex) { confirmedIDs = [...selectedIDs]; selectedIDs = []; state = "WAITING"; }
            const uiIdx = (data.idx - myIndex + 4) % 4;
            document.getElementById(`slot-${uiIdx}`).innerHTML = Array(data.cardCount).fill('<div class="card back" style="width:30px; height:45px;"></div>').join('');
            render();
        }
        if (data.type === 'FORCE_BATTLE') {
            state = "ANIMATING"; tableCards = data.tableCards; 
            for(let i=0; i<4; i++) { const ids = tableCards[i].map(c => c.id); hands[i] = hands[i].filter(card => !ids.includes(card.id)); }
            trickHistory[data.winIdx].push(...data.wonCards); runBattleAnimation(data.winIdx, data.callerIdx);
        }
        if (data.type === 'SETTLE_ALL') { balances = data.balances; diceTurn = data.winIdx; showSettle(data.diffs, data.counts, data.lastWinner, data.winIdx); }
        if (data.type === 'MSG') showToast(data.msg);
        if (data.type === 'TIMER') document.getElementById('timer-box').innerText = data.time;
        if (data.type === 'DISTRIBUTE') { document.getElementById('settlement-overlay').style.display = 'none'; resetRoundState(); hands = data.hands; sortHand(); state = "WAIT_DICE"; diceTurn = data.diceTurn; render(); }
        
        if (isHost) {
            if (data.type === 'PLAY_ACTION') serverReceiveAction(senderIdx, data.cards);
            if (data.type === 'ROLL_DICE') serverHandleRoll();
            if (data.type === 'REQ_NEXT') serverPrepareNext(data.winIdx);
        }
    }

    function render() {
        const btn = document.getElementById('main-btn');
        if (state === "WAIT_DICE") {
            btn.disabled = (myIndex !== diceTurn);
            btn.innerText = (myIndex === diceTurn) ? "ğŸ² é»æˆ‘æ“²éª°æ±ºå®šé¦–å®¶" : `ç­‰å¾… ${names[diceTurn]} æ“²éª°`;
        } else {
            btn.disabled = !((state === "MY_TURN" && selectedIDs.length > 0) || (state === "FOLLOWING" && selectedIDs.length === (currentCall?currentCall.count:0)));
            btn.innerText = (state === "WAITING") ? "ç­‰å¾…ä¸­" : (state === "MY_TURN") ? "ç¢ºèªå«ç‰Œ" : (state === "FOLLOWING") ? "ç¢ºèªè·Ÿç‰Œ" : "ç­‰å¾…ä¸­";
        }
        for(let i=0; i<4; i++) {
            let wIdx = (i + myIndex) % 4;
            let shouldGlow = (state !== "WAIT_DICE" && state !== "ANIMATING") && ((!currentCall && wIdx === turn) || (currentCall && !hasConfirmed[wIdx]));
            document.getElementById(`area-${i}`).className = `player p-${i} ${shouldGlow ? 'active-glow' : ''}`;
            document.getElementById(`name-${i}`).innerText = names[wIdx];
            document.getElementById(`bal-${i}`).innerText = `$${balances[wIdx]}`;
            document.getElementById(`status-${i}`).innerText = (state === "WAIT_DICE" && wIdx === diceTurn) ? "æ“²éª°ä¸­..." : (wIdx === turn && !currentCall) ? "å«ç‰Œä¸­" : (currentCall && !hasConfirmed[wIdx]) ? "è·Ÿç‰Œä¸­" : (hasConfirmed[wIdx]) ? "âœ“ å·²å°±ç·’" : "";
            const h = document.getElementById(`h-${i}`); h.innerHTML = '';
            if (wIdx === myIndex) {
                hands[wIdx].forEach(c => {
                    const d = document.createElement('div'); d.className = `card ${c.r?'red-p':''} ${selectedIDs.includes(c.id)?'selected':''} ${confirmedIDs.includes(c.id)?'confirmed':''}`;
                    d.innerText = c.n; d.onclick = () => { if (state === "MY_TURN" || state === "FOLLOWING") { if (selectedIDs.includes(c.id)) selectedIDs = selectedIDs.filter(id => id !== c.id); else if (selectedIDs.length < 8) selectedIDs.push(c.id); render(); } }; h.appendChild(d);
                });
            } else if (hands[wIdx]) hands[wIdx].forEach(() => h.innerHTML += '<div class="card back"></div>');
            const t = document.getElementById(`t-${i}`); t.innerHTML = '';
            trickHistory[wIdx].forEach(card => { const tag = document.createElement('div'); tag.className = `trick-tag ${card.r ? 'red-p' : ''}`; tag.innerText = card.n; t.appendChild(tag); });
        }
    }
    function broadcast(data) { if (isHost) { connections.forEach(c => c && c.send(data)); handleData(data, 0); } else hostConn.send({...data, senderName: names[myIndex]}); }
    function flow() { if (state === "WAIT_DICE") { if (myIndex === diceTurn) broadcast({type: 'ROLL_DICE'}); return; } const played = hands[myIndex].filter(c => selectedIDs.includes(c.id)); broadcast({type: 'PLAY_ACTION', cards: played}); }
    function serverHandleRoll() { const s = Math.floor(Math.random() * 4); broadcast({type: 'MSG', msg: `ğŸ² ${names[diceTurn]} æ“²å‡ºäº†é¦–å®¶ï¼š${names[s]}`}); setTimeout(() => { roundWinners = []; turn = s; currentCall = null; hasConfirmed = [false, false, false, false]; broadcast({type: 'SYNC', turn, currentCall, hasConfirmed}); }, 1500); }
    function serverReceiveAction(idx, cards) { tableCards[idx] = cards; hasConfirmed[idx] = true; broadcast({type: 'CONFIRM_OK', idx, cardCount: cards.length}); if (currentCall === null) { let pat = getPattern(cards); currentCall = {...pat, count: cards.length, callerIdx: idx}; broadcast({type: 'SYNC', turn, currentCall, hasConfirmed}); } if (hasConfirmed.every(v => v === true)) serverProcessBattle(); }
    function serverProcessBattle() { let winIdx = currentCall.callerIdx, maxPwr = currentCall.pwr; for(let i=0; i<4; i++) { let pPat = getPattern(tableCards[i]); if (tableCards[i].length === currentCall.count && pPat && pPat.name === currentCall.name && pPat.pwr > maxPwr) { maxPwr = pPat.pwr; winIdx = i; } } roundWinners.push({ winner: winIdx, tricks: currentCall.count }); broadcast({type: 'FORCE_BATTLE', tableCards, winIdx, callerIdx: currentCall.callerIdx, wonCards: [...tableCards[winIdx]]}); setTimeout(() => { if (hands[0].length === 0) serverFinalSettle(winIdx); else { turn = winIdx; currentCall = null; hasConfirmed = [false, false, false, false]; broadcast({type: 'SYNC', turn, currentCall, hasConfirmed}); } }, 4000); }
    function serverFinalSettle(lastWinnerIdx) { 
        let finalTricks = [0,0,0,0], diffs = [0,0,0,0], totalFlow = 0; roundWinners.forEach(record => { finalTricks[record.winner] += record.tricks; }); 
        let multiplier = finalTricks.some(t => t === 8) ? 2 : 1;
        for(let i=0; i<4; i++) if (i !== lastWinnerIdx) { let d = (finalTricks[i] - 5) * 20 * multiplier; diffs[i] = d; totalFlow += d; } 
        diffs[lastWinnerIdx] = -totalFlow; for(let i=0; i<4; i++) balances[i] += diffs[i]; 
        broadcast({type: 'SETTLE_ALL', balances, diffs, counts: finalTricks, lastWinner: names[lastWinnerIdx], winIdx: lastWinnerIdx}); 
    }
    function serverPrepareNext(winIdx) { let deck = [...CHESS_DATA].map(c => ({...c, id: Math.random()})).sort(() => Math.random() - 0.5); let tempHands = [[],[],[],[]]; for(let r=0; r<8; r++) for(let i=0; i<4; i++) tempHands[i].push(deck.pop()); broadcast({type: 'DISTRIBUTE', hands: tempHands, diceTurn: winIdx}); }
    function getPattern(cards) { if (!cards || cards.length === 0) return null; const len = cards.length; const isAllRed = cards.every(c => c.r), isAllBlack = cards.every(c => !c.r); if (!isAllRed && !isAllBlack) return null; const vSum = cards.reduce((s, c) => s + c.v + (c.r ? 0.5 : 0), 0); if (len === 1) return { name: "å–®å¼µ", pwr: vSum }; if ([...new Set(cards.map(c=>c.n))].length === 1 && len >= 2) return { name: (len === 2 ? "å°å­" : "åŒå­"), pwr: 1000 * len + vSum }; if (len >= 3) { const ns = cards.map(c=>c.n), u = [...new Set(ns)], grpA = isAllRed ? ['å¸¥', 'ä»•', 'ç›¸'] : ['å°‡', 'å£«', 'è±¡'], grpB = isAllRed ? ['ä¿¥', 'ç‘ª', 'ç ²'] : ['è»Š', 'é¦¬', 'åŒ…']; if ((u.every(n => grpA.includes(n)) && grpA.every(n => u.includes(n))) || (u.every(n => grpB.includes(n)) && grpB.every(n => u.includes(n)))) return { name: "é †å­", pwr: 2000 * len + vSum }; } return null; }
    function sortHand() { if(hands[myIndex]) hands[myIndex].sort((a,b) => (b.v !== a.v) ? b.v - a.v : (b.r ? -1 : 1)); }
    function resetRoundState() { trickHistory=[[],[],[],[]]; selectedIDs=[]; confirmedIDs=[]; currentCall=null; tableCards=[[],[],[],[]]; hasConfirmed=[false,false,false,false]; }
    function showToast(m) { const t = document.getElementById('toast'); t.innerText = m; t.style.display = 'block'; setTimeout(() => t.style.display = 'none', 2500); }
    async function runBattleAnimation(winIdx, callerIdx) { let curMax = -1; for(let i=0; i<4; i++) { let p = (callerIdx + i) % 4, sIdx = (p - myIndex + 4) % 4, pCards = tableCards[p], pPat = getPattern(pCards); let reveal = (i === 0) || (pCards.length === currentCall.count && pPat && pPat.pwr > curMax); if (reveal) curMax = pPat ? pPat.pwr : curMax; document.getElementById(`slot-${sIdx}`).innerHTML = pCards.map(c => `<div class="card ${c.r?'red-p':''}" style="width:35px; height:50px; font-size:16px;">${reveal ? c.n : ''}</div>`).join(''); await new Promise(r => setTimeout(r, 600)); } await new Promise(r => setTimeout(r, 1500)); for(let i=0; i<4; i++) document.getElementById(`slot-${i}`).innerHTML = ''; render(); }
    function showSettle(diffs, counts, lastWinner, winIdx) { document.getElementById('last-winner-info').innerText = `ğŸ† è´å®¶ï¼š${lastWinner}`; const list = document.getElementById('result-list'); list.innerHTML = ''; for(let i=0; i<4; i++) { let wIdx = (i + myIndex) % 4; list.innerHTML += `<div style="display:flex; justify-content:space-between; margin:5px 0; border-bottom:1px solid #444;"><span>${names[wIdx]} (${counts[wIdx]} å¢©)</span><span style="color:${diffs[wIdx]>=0?'#2ecc71':'#e74c3c'}">${diffs[wIdx]>=0?'+':''}${diffs[wIdx]}</span></div>`; } document.getElementById('btn-next-ready').onclick = () => { if (isHost) serverPrepareNext(winIdx); else hostConn.send({type: 'REQ_NEXT', winIdx: winIdx}); }; document.getElementById('settlement-overlay').style.display = 'flex'; }
</script>
</body>
</html>
